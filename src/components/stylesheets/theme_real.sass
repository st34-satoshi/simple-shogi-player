@import "piece_image_mapping"

// 盤の影
$sp_real_board_shadow_depth: 0.05em // 大きさ
$sp_real_board_shadow_blur:  0.05em // ぼかし度合い

// 駒の影
$sp_real_piece_shadow_depth: 0.1em // 大きさ
$sp_real_piece_shadow_blur:  0.1em // ぼかし度合い

// 持った駒の影
$sp_real_hold_shadow_depth: 0.15em // 大きさ
$sp_real_hold_shadow_blur:  0.15em // ぼかし度合い

=image_shadow($x, $weight)
  filter: drop-shadow($x $x $weight rgba(0, 0, 0, 0.3))

%board_shadow
  &:after
    +image_shadow($sp_real_board_shadow_depth, $sp_real_board_shadow_blur)

//--------------------------------------------------------------------------------

$advance: 26%                 // 大きくするほど駒が下に移動する

// 駒のテクスチャの共通設定
%piece_fore_texture_shared
  color: transparent            // テキストを消す
  background-repeat: no-repeat
  // background-size: contain      // contain にすると端が欠けない
  // background-size: 50%          // 駒の大きさ contain にしとけばいい
  background-size: 84%          // 駒の大きさ contain にしとけばいい

// 駒のテクスチャ用(先手だけの画像を用意している場合)
%piece_fore_texture_for_black_onoly
  background-position: 50% 50% + $advance // 先手も後手も下寄り配置 (後手は判定しているので見た目は上にずれる)

// 駒のテクスチャ用(先後両方の画像を用意している場合)
%piece_fore_texture_for_both
  &.location_black
    @extend %piece_fore_texture_for_black_onoly // 先手は枠の下寄り配置
  &.location_white
    background-position: 50% 50% - $advance // 後手は枠の上寄り配置

//--------------------------------------------------------------------------------

%real_hoverable_bg
  &.hoverable_p
    &:hover
      background-color: $sp_real_selectable_color

// 背景はテクスチャなので色を指定できない場合
%real_hoverable_opacity
  &.hoverable_p
    &:hover
      opacity: 0.8

// 選択できる駒に指定する
%dom_real_selectable
  +image_shadow($sp_real_piece_shadow_depth, $sp_real_piece_shadow_blur)
  &.holding_p
    +desktop
      opacity: 0.4  // 駒を持ち上げたので元の駒を薄くする
    +touch
      background-color: $sp_real_holding_color
      // さらに駒を持ったときは色を濃くする
      &:hover
        background-color: $sp_real_holding_color

  &.selectable_p
    &:hover
      // スマホでは手を離しても hover 状態を保持してしまう
      // そのため2手目に1手目の指し手の hover の色がつきっぱなしになってしまう
      // そうすると手目より1手目の方が目立って違和感がある
      // なのでマウスが使える環境だけを対象にする
      +desktop
        // 選択できる駒だけ反応する
        // background プロパティをつかうと他の設定をリセットしてしまうので注意
        background-color: $sp_real_selectable_color

  @extend %real_hoverable_bg

@keyframes real_blink
  0%
    background-color: $sp_real_current_bg1
  100%
    background-color: $sp_real_current_bg2

.shogi-player
  &.theme-real
    // 駒の種類
    &.piece_variant-a
      .piece_fore
        @extend %piece_fore_texture_for_both
        +piece_image_variant_a_pack
    &.piece_variant-b
      .piece_fore
        @extend %piece_fore_texture_for_black_onoly
        +piece_image_variant_b_pack
        &.location_white
          @extend %is_flip
    &.piece_variant-c
      .piece_fore
        @extend %piece_fore_texture_for_both
        +piece_image_variant_c_pack

    // 駒 (あちこちにある)
    .piece_back
      @extend %dom_real_selectable
      line-height: 100%         // これで隙間ができなくなる(が、意味がよくわかってない)
      &.origin_place
        background-color: $sp_real_origin_bg
      &.current
        animation: real_blink 0.5s ease-in-out infinite alternate
      .piece_fore
        @extend %piece_fore_texture_shared
        height: 100%   // .piece_back のサイズを継承。inherit だと災いがおきやすいので100%を使う

    //////////////////////////////////////////////////////////////////////////////// 駒箱
    .PieceBox
      @extend %board_shadow
      @extend %board_texture_bg
      @extend %real_hoverable_opacity
      padding: 0.25em
      .piece_count
        position: relative
        top: 0.1em
        font-size: 0.4em
        margin-left: -0.3em

    &.horizontal
      .PieceBox
        font-size: 0.9em
        max-width:  4em
        min-height: 2.5em

    &.vertical
      .PieceBox
        font-size: 1.5em
        min-height: 1.2em

    //////////////////////////////////////////////////////////////////////////////// 駒台
    .Membership
      .MembershipStand
        @extend %board_texture_bg
        @extend %real_hoverable_opacity
        font-size: 1.3em
        li
          .piece_count
            position: relative
            top: 0.2em
            font-size: 0.4em
            margin-left: -0.3em

      &.location_black
        .MembershipStand
          &:after
            +image_shadow($sp_real_board_shadow_depth, $sp_real_board_shadow_blur)
      &.location_white
        .MembershipStand
          &:after
            +image_shadow(-$sp_real_board_shadow_depth, $sp_real_board_shadow_blur) // 相手の駒台は逆になっているため影を逆にする
          .piece_back
            @extend %is_flip   // 後手の下向きの駒が、駒台が逆になることで上に向いているため、下向きにする

    // 駒台(横)
    &.horizontal
      .Membership
        .player_name
          margin-top: 0.2em
          margin-bottom: 0.5em
        .MembershipStand
          width: 1.4em
          min-height: 3em
          padding-top:    0.15em
          padding-bottom: 0.15em

    // 駒台(縦並び)
    &.vertical
      .Membership
        .player_name
          margin-right: 0.2em
        .MembershipStand
          min-width: $sp_piece_stand_size_if_blank
          padding-left:  0.15em
          padding-right: 0.15em

    //////////////////////////////////////////////////////////////////////////////// 盤
    .board_outer
      @extend %board_shadow
      @extend %board_texture_bg
      margin: 0 $sp_real_margin
      padding: 1.4%               // 盤の隅の隙間
      .board_inner
        +board_star_mark_define($sp_real_star_color)
        td
          border: $sp_real_grid_inner solid $sp_real_grid_color // 盤面の罫線
          .piece_back
            // 画像の場合 padding-top: 0.5em は使えない
            .piece_fore
              // padding-top: 1.2em // 画像の場合使えない

    // カーソル位置に表示する持駒
    .cursor_elem
      +image_shadow($sp_real_hold_shadow_depth, $sp_real_hold_shadow_blur)

//////////////////////////////////////////////////////////////////////////////// valiation

=bg_variant_define($key, $file)
  &.bg_variant-#{$key}
    .board_outer, .PieceBox, .MembershipStand
      &:after
        background-image: url("#{$sp_assets_dir}/background/#{$file}")
        // opacity: 1.0

// (loop for i from ?a to ?z do (save-excursion (insert (format "%c" i))) (next-line))
.shogi-player
  &.theme-real
    +bg_variant_define(a, "0100_wood_01.png")
    +bg_variant_define(b, "0160_japanese-paper_00012.jpg")
    +bg_variant_define(c, "0210_japanese-paper_00085.jpg")
    +bg_variant_define(d, "0230_japanese-paper_00128.jpg")
    +bg_variant_define(e, "0250_paper_co_cyan_papar.png")
    +bg_variant_define(f, "0260_paper_co_white_paper.png")
